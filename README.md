# fastapi
api development

uvicorn app.main:app --reload   # запуск


alembic позволяет контролировать изменения в бд. можно вручную прописать upgrade и downgrade,
также можно и сделать autogenerate и алембик сам пропишет апгрейд и даунгрейд.
Сущности alembic и SQLAlchemy:
    Metadata -  контейнер,содержит информацию о схеме БД:таблицы,индексы,типы данных и т.п.
                Умеет получать информацию о том , какие сейчас сущности есть в базе(reflect)
                Позволяет указать шаблоны именования индексов и constraint-ов по умолчанию.
    Table -     у таблицы есть название, столбцы с типами данных, и она обязательно ссылается
                на реестр MetaData, так как MetaData — это реестр всего, что вы описываете.
                И есть столбцы с типами данных. 
    Engine -    Скрывает за собой пул подключений и диалект, которые работают непосредственно
                с модулем DBAPI(драйвером) и БД.
    Dialect -   это то, как Engine общается уже с разными БД.
Команды alembic:
    alembic init alembic (инициализация которая создает файлы для работы alembic)
        Создаст файлы:
            alembic.ini (общая конфигурация)
            script.py.mako (шаблон для новых миграций)
            env.py (контролирует ход выполнения команд и позволяет кастомизировать его под себя.
                    Именно в этот файл подключается объект MetaData.)
    alembic revision -m 'message' (проведет ревизию на изменения и создаст файл для запуска изменений)
    alembic upgrade head (запустит изменения после предыдущей ревизии)
    alembic upgrade head (откатит изменения)


CORS - middleware который позволяет настроить апи и методы чтобы разрешить другим доменам отправлять нам на сервер
запросы.


pip freeze > requirements.txt (команда создает файл в котором версии используемых пакетов в проекте)
pip install -r requirements.txt (команда устанавливает все версии пакетов указанные в этом файле)



psycopg2 не деплоится на хероку, вместо него надо устанавливать psycopg2-binary  


Heroku:
heroku create appname (создает приложение на хероку)
git push heroku main (пушит изменения с гита на хероку)
heroku logs -t  (посмотреть логи)
heroku apps:info appname (посмотреть информацию об приложении или вобщем(без appname))
heroku run 'alembic upgrade head' (запуск изменений в базе данных)
heroku ps:restart (перезапуск приложения)


Docker:
docker build -t fastapi_crud_vote .  (создает образ приложения)
docker images -a (посмотреть все образы)
docker-compose up -d (запуск контейнера)
docker exec -it  fastapi_crud_vote-api-1 bash (зайти через консоль в контейнер)
docker-compose -f docker-compose-dev.yml up -d (выбрать с каким файлом запускать)


Pytest:
Имена тестовых функциц должны начинатся со слова test.
@pytest.fixture (позволяет сократить объем кода, один раз создав экземпляр класса,можно его передать в другие тесты)
@pytest.mark.parametrize (передает аргументы в функцию-тестер(значения и ожидание))
В fastapi есть инструмент для тестирования TestClient. 
